{% extends 'base.html' %}
{% block content %}
<div class="dashboard-layout">
 
  <main class="dashboard-content p-4">

    <!-- Attendance Prediction Section -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-bold">Attendance Prediction</div>
      <div class="card-body text-center">
        {% if prediction_percent >= 75 %}
          <h4 class="text-success">üéâ You are on track! Current attendance estimate: {{ prediction_percent }}%</h4>
          <p>You are likely to maintain at least 75% attendance this month.</p>
        {% else %}
          <h4 class="text-danger">‚ö†Ô∏è Warning! Current attendance estimate: {{ prediction_percent }}%</h4>
          <p>You might fall below the required 75% attendance this month. Increase attendance to improve.</p>
        {% endif %}
      </div>
    </div>

    {% if has_data %}
      <div class="row g-4 equal-height">

        <!-- Bar Chart -->
        <div class="col-lg-4 col-md-6 col-12">
          <div class="card p-3 h-100 d-flex flex-column">
            <h5 class="mb-3">Lectures Conducted vs Attended</h5>
            <canvas id="barChart" class="flex-grow-1"></canvas>
          </div>
        </div>

        <!-- Pie Chart -->
        <div class="col-lg-4 col-md-6 col-12">
          <div class="card p-3 h-100 d-flex flex-column">
            <h5 class="mb-3">This Month Lecture Status</h5>
            {% if pie_has %}
            <canvas id="pieChart" class="flex-grow-1"></canvas>
            {% else %}
            <div class="alert alert-info flex-grow-1 d-flex align-items-center justify-content-center">No records for this month yet.</div>
            {% endif %}
          </div>
        </div>

        <!-- Line Chart -->
        <div class="col-lg-4 col-md-12 col-12">
          <div class="card p-3 h-100 d-flex flex-column">
            <h5 class="mb-3">Monthly Attendance %</h5>
            <canvas id="lineChart" class="flex-grow-1"></canvas>
          </div>
        </div>

      </div>

      <!-- Chart JS -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        // Bar Chart - Animated, with legends and rainbows for easy reading
        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: {{ bar_labels|tojson }},
            datasets: [
              {
                label: 'Conducted',
                data: {{ conducted_counts|tojson }},
                backgroundColor: '#2563eb'
              },
              {
                label: 'Attended',
                data: {{ attended_counts|tojson }},
                backgroundColor: '#16a34a'
              }
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            animation: { duration: 800, easing: 'easeOutQuart' },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Number of Lectures' },
                ticks: { stepSize: 1 }
              },
              x: {
                title: { display: true, text: 'Subjects' },
              }
            },
            plugins: {
              legend: { position: 'top', labels: { boxWidth: 16, padding: 20 } },
              tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
          }
        });

        // Pie Chart - Smooth with hover effect
        {% if pie_has %}
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: ['Conducted', 'Attended', 'Cancelled'],
            datasets: [{
              data: [{{ pie_conducted }}, {{ pie_attended }}, {{ pie_cancelled }}],
              backgroundColor: ['#2563eb', '#16a34a', '#facc15'],
              hoverOffset: 40,
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            animation: { duration: 700, easing: 'easeOutCirc' },
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
        {% endif %}

        // Line Chart - Smaller with smooth curves and points, no legend
        const lineCtx = document.getElementById('lineChart').getContext('2d');
        new Chart(lineCtx, {
          type: 'line',
          data: {
            labels: {{ months|tojson }},
            datasets: [{
              label: 'Attendance %',
              data: {{ percentages|tojson }},
              fill: true,
              borderColor: '#6d28d9',
              backgroundColor: 'rgba(109,40,217,0.14)',
              tension: 0.4,
              pointRadius: 5,
              pointBackgroundColor: '#6d28d9',
              pointHoverRadius: 7,
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            animation: { duration: 900, easing: 'easeOutQuart' },
            layout: { padding: { top:10, bottom:10 } },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: 'Attendance %' }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true, mode: 'nearest' }
            }
          }
        });
      </script>
    {% else %}
      <div class="alert alert-info my-3">No attendance records found. Mark attendance to see analytics!</div>
    {% endif %}
  </main>
</div>

<style>
  /* Make all cards equal height */
  .equal-height > [class*='col-'] {
    display: flex;
  }
  .equal-height .card {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
  }
  .equal-height .card canvas {
    flex-grow: 1;
  }

  /* Responsive padding and margins */
  @media (max-width: 991px) {
    .dashboard-content {
      padding: 24px 12px;
    }
  }
  @media (max-width: 575px) {
    .dashboard-content {
      padding: 16px 8px;
    }
  }
</style>
{% endblock %}
